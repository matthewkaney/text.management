<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <style type="text/css">
      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
      }

      canvas {
        display: block;
      }
    </style>
    <script type="module">
      import { renderer } from "./threeDee.js";

      import Hydra from "hydra-synth";

      const hydra = new Hydra({ autoLoop: false });
      s0.init({ src: renderer.domElement });

      let lastTime = performance.now();

      let updater = () => {};

      window.move = (updateFunc) => {
        updater = updateFunc;
      };

      function animate(thisTime) {
        requestAnimationFrame(animate);

        let dt = thisTime - lastTime;
        lastTime = thisTime;

        try {
          updater(thisTime);
        } catch (e) {
          console.log(e);
        }

        renderer.render(scene, camera);

        hydra.tick(dt);
      }

      animate(lastTime);

      import { getMessages } from "../../../app/osc/osc";

      window.addEventListener("message", ({ data, ports }) => {
        if (data === "channel" && ports.length > 0) {
          let [port] = ports;

          port.addEventListener("message", ({ data }) => {
            for (let {
              address,
              args: [code],
            } of getMessages(data)) {
              if (address === "/code" && typeof code === "string") {
                try {
                  eval(code);
                } catch (error) {
                  console.log(error.message);
                }
              }
            }
          });

          port.addEventListener("messageerror", (event) => {
            console.error(event);
          });

          port.start();
        }
      });
    </script>
  </head>
</html>
